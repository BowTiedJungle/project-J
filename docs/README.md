# project-J


## Overview
Project J is a jungle-native project seeking to allow NFT-verified proof of jungle membership. This jungle membership will then provide access to private resources such as a jungle wiki, forums, shitpost hall of fame, or whatever else we want to add to it. Deployment will occur in two phases. Phase 1 will be governed by trusted jungle members. All funds will be behind a multisig. Phase 2 will move to DAO governance of the Project J protocol.

---

## Technical details
Building for Ethereum mainnet. Uses hardhat development environment. Uses OpenZeppelin proxy pattern for upgradeable smart contracts. Will use Gnosis safe for multisig.

### Hardhat config
```
cd ./solidity
npx hardhat
```

In the `hardhat.config.js` file, add the following lines:
```
require("@nomiclabs/hardhat-waffle");
require('@openzeppelin/hardhat-upgrades');
require("hardhat-gas-reporter");
```

The lines
```
require("@nomiclabs/hardhat-solhint");
require("hardhat-docgen")
```
may be added for extra checking and documentation generation and are accessible by `npx hardhat check` and `npx hardhat docgen` respectively.

### Commands (execute from solidity directory)
Running scripts:
`npx hardhat run scripts/deploy.js`

Optional `--network` flag deploys to specific networks defined in `hardhat.config.js`

Running unit tests:
`npx hardhat test`

Running local dev node:
`npx hardhat node` then start a second terminal, and run scripts from that one. This can be used to verify correct performance of the upgradeable infrastructure for instance.

### Running Slither security analysis tool
Thanks to @BowTiedFireFox for help with this part. Install docker, then:
```
docker pull trailofbits/eth-security-toolbox
cd project-J/solidity
docker run -it -v ${PWD}:/share trailofbits/eth-security-toolbox
cd /share
slither contracts/ProjectJ.sol  --solc-remaps @openzeppelin=node_modules/@openzeppelin
```

There are many printer options available via slither also for other analysis.

---

## Deployment Walkthrough

### Environment Setup

Your networks section of `hardhat.config.js` must be set up with an appropriate alchemy or infura API URL (or your local node URL if you're a tryhard) and the private key for your interacting account. ***WARNING: DO NOT PUSH THIS FILE TO GITHUB!***

You must also obtain an etherscan API key and add `require("@nomiclabs/hardhat-etherscan");` to your `hardhat.config.js` to verify on etherscan.

### Deploy Gnosis Safe

This is done through https://gnosis-safe.io/app/welcome. Keep track of this address.

### Prepare contracts

***CRITICAL: The gnosis safe address must be hardcoded in the contracts as the `governor` constant address!***

The mint price must also be hardcoded. Ensure it is correct!
### Deploy

Final checks. Ensure that the desired addresses are set for the whitelist, initial pausers, and initial moderators. Check that the base URI is correct

`npx hardhat run scripts/deploy.js --network rinkeby`

This will deploy the transparent proxy structure to the rinkeby network. This includes 3 contracts.

* TransparentUpgradeableProxy
* ProxyAdmin
* ProjectJ implementation contract

The interaction point is the TransparentUpgradeableProxy. It will delegate any calls made to it (by any address other than the ProxyAdmin) to the implementation contract. The ProxyAdmin only has to be interacted with when changing which implementation contract will recieve the DELEGATECALL. For more information see here https://docs.openzeppelin.com/upgrades-plugins/1.x/proxies or here https://forum.openzeppelin.com/t/openzeppelin-upgrades-step-by-step-tutorial-for-hardhat/3580

The deployment structure and addresses may be seen at the `solidity\.openzeppelin\rinkeby.json` file, which is an artifact generated by the OpenZeppelin Upgrades hardhat plugin.

### Etherscan Verify

Run `npx hardhat run scripts/etherscan_verify.js --network rinkeby` to verify the implementation on Etherscan. The proxies should autoverify as they match deployed bytecode known to be proxy contracts.

### Transfer ProxyAdmin Ownership

***CRITICAL: Set Gnosis Safe address in this script to the deployed safe instance before running***

Run `npx hardhat run scripts/transfer_admin.js --network rinkeby` to transfer ownership of the ProxyAdmin contract to the Gnosis safe.

At this stage you should be done with deployment.

### To Upgrade Implementation Contract

Check the values, then run `npx hardhat run scripts/prepare_upgrade.js --network rinkeby` to deploy the V2 contract.

Verify on Etherscan using the same procedure as above.

Go to the Gnosis Safe interface -> Apps -> OpenZeppelin. Enter the proxy address and the new implementation address into the `Upgrade a contract` interface. This will switch the implementation

---

## Rinkeby Deployment Addresses

Proxy: https://rinkeby.etherscan.io/address/0xe3B72c01DC44d0C6925E776471bFdFd4A1CD7112

ProxyAdmin: https://rinkeby.etherscan.io/address/0xfF2c41d306098Ce69316C781137EaF05FABDFF6b

ProjectJ Implementation: https://rinkeby.etherscan.io/address/0x776B79526490E7Ecc848Ca38dC7cAb0882517797

ProjectJTest Implementation with 0.01 ETH mint price: https://rinkeby.etherscan.io/address/0x73c02580bc7A16276Be5d2bA4afD14022312221B

Gnosis Safe Instance:
https://rinkeby.etherscan.io/address/0x09657c51c466E78e2a2BaF0232EA78BB9C5DAb3d

Testnet Gnosis Safe Owners:

* BowTiedPickle (2x wallets)
* BowTiedHeron
* BowTiedArcticWolf

Safe Transaction Threshold: 2/4

---

## Programmatically Interacting With the Contract

Use `npx hardhat run scripts/run.js --network rinkeby` after modifying the contents to call the desired function. You must attach the proxy address to the contract ABI to be able to call.

---

## To-do
A very unexhaustive list of things needing attention.

* Project Admin
    * Notion/Trello/Etc for tracking and documentation
* Solidity
    * Test on Rinkeby
* Website Design
    * Requirements definition
    * Wireframing
    * Tech stack definition

## Requirements

* NFT
    * On-chain good standing yes/no flag
    * Upgradable contract
    * Access control for certain functions (contract admin, good standing revocation)
    * Avatar is mutable, avatar process lives off chain
    * Funds only payable to multisig
